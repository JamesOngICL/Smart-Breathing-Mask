<html>
<head>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script type="text/javascript">
 	window.onload = function() {
    	console.log("LOADED");
      //https://www.youtube.com/watch?v=H5LneQjrnF4
    	//Configuration variables
    	var updateInterval = 40 //in ms
    	var numberElements = 250;
    	//Globals
    	var updateCount = 0;
    	// Chart Objects
    	var xAccelChart = $("#xAccelChart");
      var yAccelChart = $("#yAccelChart");
    	//chart instances & configuration
    	var commonOptions = {
      scales: {
          	xAxes: [{
            type: 'time',
            time: {
              unit : 'second'
            }
            }]
        },
        legend: {display: false},
        tooltips:{
          enabled: false
        }
    	};
    	var xAccelChartInstance = new Chart(xAccelChart, {
        type: 'line',
        data: {
          datasets: [{
              label: "Accelerometer",
              data: 0,
              fill: false,
              borderColor: '#343e9a',
              borderWidth: 1
          }]
        },
        options: Object.assign({}, commonOptions, {
          title:{
            display: true,
            text: "Temperature",
            fontSize: 18,
            fontColor: "green"
          },
          scales: {
          	xAxes: [{
            type: 'time',
            time: {
              unit : 'second'
            },
            gridLines: {
              color: "rgba(0, 0, 0, 0)",
            }   
            }],
            yAxes: [{
              ticks:{
                max: 30,
                min: 20
              }
            }]
          },
          elements: {
                    point:{
                        radius: 0
                    }
          }
        })
    });
      var yAccelChartInstance = new Chart(yAccelChart, {
          type: 'line',
          data: {
            datasets: [{
                label: "Y Acceleration",
                data: 0,
                fill: false,
                borderColor: '#343e9a',
                borderWidth: 1
            }]
          },
          options: Object.assign({}, commonOptions, {
            title:{
              display: true,
              text: "Magnitude of Acceleration",
              fontSize: 18
            },
            scales: {
              xAxes: [{
              type: 'time',
              time: {
                unit : 'second'
              },
              gridLines: {
                color: "rgba(0, 0, 0, 0)",
              }  
            }],
              yAxes: [{
                ticks:{
                  max: 2,
                  min: -2
                }
            }]
          },
            elements: {
              point:{
                radius: 0
              }
            }
          })    });
    function addData(data) {
      if(data){
        xAccelChartInstance.data.labels.push(new Date());
        xAccelChartInstance.data.datasets.forEach((dataset) =>{dataset.data.push(data['xA'])});
        xAccelChartInstance.options.title.fontColor = data['xAcolor'];
        yAccelChartInstance.data.labels.push(new Date());
        yAccelChartInstance.data.datasets.forEach((dataset) =>{dataset.data.push(data['yA'])});
        if(updateCount > numberElements){
          xAccelChartInstance.data.labels.shift();
          xAccelChartInstance.data.datasets[0].data.shift();
          yAccelChartInstance.data.labels.shift();
          yAccelChartInstance.data.datasets[0].data.shift();
        }
        else updateCount++;
        xAccelChartInstance.update();
        yAccelChartInstance.update();
      }
    };

    //Gaussian Filtering//
    var prevval1 = new Array(21);
    var prevval2 = new Array(21);
    
    function pusharr(data1,data2){
      prevval1.shift();
      prevval1[20]=data1;
      prevval2.shift();
      prevval2[20]=data2;
    }
    function filt(){
      //1d gaussian k = 3, sigma = 3, kernal size = 19
      var filter = [0,0.0024020332548697417, 0.005842766831189515, 0.01271754116880599, 0.024770387852997698, 0.043172531888630586, 0.06733289518468631, 0.09397062513676754, 0.11735510892143318, 0.13114657203397997, 0.13114657203397997, 0.11735510892143318, 0.09397062513676754, 0.06733289518468631, 0.043172531888630586, 0.024770387852997698, 0.01271754116880599, 0.005842766831189515, 0.0024020332548697417, 0.0008836586514767013,0];
      totsum1 = 0;
      totsum2 = 0;
      for(let i = 0; i < prevval1.length; i++){
        totsum1 = totsum1 + parseFloat(prevval1[i])*filter[i];
        totsum2 = totsum2 + parseFloat(prevval2[i])*filter[i];
      }
      return [totsum1, totsum2];
    }
    //--------------------//

    function updateData(data) {
      console.log("Update Data");
	    var val = Math.floor(Math.random() * 10);
	    addData({'xA':val});
      setTimeout(updateData,updateInterval);
    }	
    function updateChart() {
      $.ajax({
        type:"GET",
        datatype: 'json',
        url: "{% url 'opencare:getdata' %}",
        data: {
          'id': "{{id}}"
        },
        success: function(data){
          console.log("Update Data");
          pusharr(data['temperaturereading'],data['accelerometerreading']-1);
          const val = filt();

          //Color changer
          var color;
          if(val[0]>25){
            color = "red";
          }
          else{
            color = "green";
          }

	        addData({'xA':val[0],'yA':val[1],'xAcolor':"grey"});

        },
        error: function(){
          console.log("error");
          var val = Math.floor(Math.random() * 10);
	        addData({'xA':filt(),'yA':data['accelerometerreading']-1});
        }
      });
      setTimeout(updateChart,updateInterval);
    }
    updateChart();
  }
</script>
  <style>
  .container{
    display:flex;
  }
  .label{
    flex:1;
    vertical-align: middle;
    text-align: center;
  }
  .x{
    flex:3;
    text-align: center;
    background-color: rgb(251, 251, 251);
    margin: 10px;
  }
  .y{
    flex:3;
    text-align: center;
    background-color: rgb(251, 251, 251);
    margin: 10px;
  }
  h1{
    text-align: center;
  }
  </style>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.1/jquery.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
</head>
<body>
  {% if user.is_authenticated %}
  <div class="w3-top">
    <div class="w3-bar w3-white w3-wide w3-padding w3-card">
      <a class="w3-bar-item w3-button" type="submit" href="/signout"><b>Open</b>Care</a>
      <!-- Float links to the right. Hide them on small screens -->
      <div class="w3-right">
        <a href="/profile" class="w3-bar-item w3-button" type="submit">Profile</a>
        <a href="/yourdata" class="w3-bar-item w3-button" type="submit">Your Data</a>
        <a href="/favorites" class="w3-bar-item w3-button" type="submit">Favorites</a>
        <a href="/search" class="w3-bar-item w3-button"><b>Search</b></a>
      </div>
    </div>
  </div>
  <br><br><br>
  <h3><center><b>Live Readings for {{id}}</b></center></h3>
  <br>
  <div id="orientationContainer" class="container">
  <div id="xAccel" class="x">
      <canvas id="xAccelChart"></canvas>
  </div>
  <div id="yAccel" class="y">
    <canvas id="yAccelChart"></canvas>
  </div><!--yAccel-->
  </div> 
  {% else %}
  {% endif %}
</body>
</html>